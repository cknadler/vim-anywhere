#!/bin/bash
#
# vim-anywhere - use Vim whenever, wherever
# Author: Chris Knadler
# Homepage: https://www.github.com/cknadler/vim-anywhere
#
# Open a temporary file with Vim. Once Vim is closed, copy the contents of that
# file to the system clipboard.

###
# defs
###

err() { echo -e "$@" 1>&2; }

###
# opts
###

while getopts ":v" opt; do
  case "$opt" in
    v) set -x ;;
    \?) echo "Invalid option: -$OPTARG" >&2 ;;
  esac
done

###
# run
###

aw_path=$HOME/.vim-anywhere
dir=/tmp/vim-anywhere
file=$dir/doc-$(date +"%y%m%d%H%M%S")

# file prep
mkdir -p $dir
touch $file
chmod o-r $file # Make file only readable by you

# Linux
if [[ "$OSTYPE" == "linux-gnu" ]]; then
  gvim --nofork $file
  cat $file | xclip -selection clipboard

# OSX
elif [[ "$OSTYPE" == "darwin"* ]]; then
  macvim=MacVim.app
  app=$(osascript $aw_path/script/current_app.scpt)

  find {/Applications,~/Applications} -name '*.app' -maxdepth 1 -mindepth 1 | grep -s $macvim >/dev/null

  if [ $? -eq 1 ]; then
    err "$macvim does not seem to be installed. Please make sure $macvim is installed first."
    exit 1
  fi

  open -Wna $macvim $file
  # todo, fix invalid file
  pbcopy < $file

  osascript -e "activate application \"$app\""
fi
